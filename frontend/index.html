<link rel="import" href="style.html">

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <!-- <title>marcel-plugin-gdrive-carousel</title>
  <link rel="stylesheet" type="text/css" href="style.css"> -->
  <script src="./marcel.js"></script>
</head>

<body>

  <div id="container">
    <img id="img" role="presentation" />
  </div>

  <style>
    #container {
      display: flex;
      justify-content: center;
      width: 100vw;
      height: 100vh;
    }

    img {
      width: 100%;
      height: 100%;
    }

    .proportional {
      width: auto;
      height: auto;
      margin: auto;
      max-width: 100%;
      max-height: 100%;
    }
  </style>

  <script>
    const api = (driveFolderId, apikey) => `https://www.googleapis.com/drive/v3/files?q='${driveFolderId}'+in+parents&key=${apikey}`
    const img = (id, apikey) => `https://drive.google.com/uc?export=view&id=${id}&key=${apikey}`

    class GDriveCarousel extends Marcel.Plugin {
      constructor() {
        super({
          defaultProps: {
            duration: 60,
            saveProportions: true,
          }
        })

        this.img = document.getElementById('img')

        this.fetchPhotos()
      }

      fetchPhotos() {
        const { driveFolderId, apikey } = this.props
        fetch(api(driveFolderId, apikey))
          .then(response => response.json())
          .then(json => this.setPhotos(json))
          .then(() => this.nextPhoto())
      }

      setPhotos(directory) {
        const { apikey } = this.props
        this.availablePhotos = directory.files.map(({ id }) => img(id, apikey))
        this.currentPhoto = 0
        console.log("Photos found : ", this.availablePhotos)
      }

      nextPhoto() {
        const { duration } = this.props

        if (this.currentPhoto == this.availablePhotos.length - 1) this.currentPhoto = 0
        else this.currentPhoto++

        this.img.src = this.availablePhotos[this.currentPhoto]

        console.log("Next photo : ", this.img.src)

        this.nextTimeout = setTimeout(() => this.nextPhoto(), (duration || 30) * 1000)
      }

      propsDidChange(prevProps) {
        if (this.props.apikey !== prevProps.apikey || this.props.driveFolderId !== prevProps.driveFolderId) {
          clearTimeout(this.nextTimeout)
          this.fetchPhotos()
        }
      }

      render() {
        this.img.className = this.props.saveProportions ? 'proportional' : ''
      }
    }

    const instance = new GDriveCarousel()
  </script>
</body>

</html>